name: Rerun Failed Tests

on:
  workflow_dispatch:
    inputs:
      original_run_id:
        description: 'The run ID of the original workflow'
        required: true
      merge_reports:
        description: 'Merge rerun report with main report?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
jobs:
  rerun-failed-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download combined rerun list artifact from original run
        run: |
          gh run download ${{ inputs.original_run_id }} -n combinedRerunList -D ./rerun-tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read combinedRerunList.txt
        id: read_file
        run: |
          if [ -f ./rerun-tests/combinedRerunList.txt ]; then
            FAILED_TESTS=$(cat ./rerun-tests/combinedRerunList.txt | paste -sd "," -)
            echo "Failed tests found: $FAILED_TESTS"
            echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          else
            echo "No rerun file found"
            echo "failed_tests=" >> $GITHUB_OUTPUT
          fi
      #- name: Trigger main workflow via gh api
        #id: trigger_main
          #env:
        #GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          #run: |
          #gh api repos/${{ github.repository }}/actions/workflows/SeleniumGridWithMultipleRunners.yml/dispatches \
          #-f ref=main \
          #-f inputs.TestList="${{ steps.read_file.outputs.failed_tests }}" \
          #-f inputs.Mvn_Group="ShardRun" \
          #-f inputs.Is_Rerun="true" \
          #-f inputs.Run_Headless="true"

      - name: Trigger main workflow for rerun
        if: ${{ steps.read_file.outputs.failed_tests != '' }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: SeleniumGridWithMultipleRunners.yml
          inputs: |
            {
              "TestList": "${{ steps.read_file.outputs.failed_tests }}",
              "Mvn_Group": "ShardRun",
              "Run_Headless": "true",
              "Is_Rerun": "true"
            }
      - name: Get rerun run ID
        id: get_rerun_run_id
        run: |
          RERUN_RUN_ID=$(gh run list --workflow SeleniumGridWithMultipleRunners.yml --json databaseId --jq '.[0].databaseId')
          echo "RERUN_RUN_ID=$RERUN_RUN_ID" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download original run allure-results
        run: |
          gh run view ${{ inputs.original_run_id }} --log --json artifacts --jq '.artifacts[].name'
          gh run download ${{ inputs.original_run_id }} -n allure-results-* -D ./original-allure-results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download rerun allure results
        run: |
          gh run download $RERUN_RUN_ID -n allure-results-* -D ./rerun-allure-results

      - name: Merge original and rerun allure results
        run: |
          mkdir merged-allure-results
          cp -r ./original-allure-results/* merged-allure-results/
          cp -r ./rerun-allure-results/* merged-allure-results/
          allure generate merged-allure-results -o combined-allure-report --clean

      - name: Upload merged Allure report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: combined-allure-report
          path: combined-allure-report
          if-no-files-found: error
          retention-days: 14

      - name: Deploy combined Allure report to GitHub Pages (/combined-report)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: combined-allure-report
          publish_branch: gh-pages
          destination_dir: combined-report
          keep_files: true
          force_orphan: false
          commit_message: "Deploy Combined Allure Report - ${{ github.sha }}"
          allow_empty_commit: true

      - name: Log completion
        run: echo "Rerun failed tests workflow completed."









